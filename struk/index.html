<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Struk • Rumah Nenek Laundry</title>
<style>
  :root { font-family: 'Courier New', monospace; color:#000; }
  body{ margin:0; padding:12px; background:#f6f6f6; }
  .card{ max-width:720px; margin:0 auto; background:#fff; padding:12px; border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,0.06);}
  h2{ margin:6px 0 12px 0; font-size:18px; text-align:center;}
  label{ display:block; font-size:13px; margin-top:8px; }
  input[type=text], input[type=tel], input[type=number], textarea {
    width:100%; padding:8px; font-size:15px; box-sizing:border-box; margin-top:4px; border:1px solid #ddd; border-radius:6px;
  }
  textarea { resize:vertical; }
  .row{ display:flex; gap:8px; }
  .row > * { flex:1; }
  button{ padding:10px 12px; border:none; border-radius:6px; background:#1f8f8f; color:#fff; font-size:15px; margin-top:12px; width:100%; cursor:pointer; }
  button.secondary{ background:#4a5568; }
  button.copy{ background:#718096; }
  .muted{ color:#666; font-size:13px; margin-top:6px; }
  .preview{ margin-top:12px; padding:10px; border:1px dashed #222; font-family:monospace; white-space:pre-wrap; background:#fff; }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; }
  .controls button{ flex:1; min-width:100px; }
  /* ukuran thermal printer 58mm (~280px) */
  .thermal { width:280px; max-width:100%; margin:10px auto; font-size:12px; line-height:1.2; padding:8px; border-radius:4px; background:#fff; color:#000; }
  @media print {
    body * { visibility:hidden; }
    .thermal, .thermal * { visibility:visible; }
    .thermal { position:absolute; left:0; top:0; width:100%; }
  }
</style>
</head>
<body>
  <div class="card">
    <h2>Struk • Rumah Nenek Laundry</h2>

    <!-- PIN screen -->
    <div id="pinScreen">
      <label>Masukkan PIN (online)</label>
      <input id="pinInput" type="text" placeholder="PIN" autocomplete="off" />
      <button id="pinBtn">Masuk</button>
      <div id="pinMsg" class="muted"></div>
    </div>

    <!-- Main form -->
    <div id="mainScreen" style="display:none;">
      <label>No</label>
      <input id="no" type="text" readonly />

      <label>No Struk</label>
      <input id="noStruk" type="text" readonly />

      <label>Nama</label>
      <input id="nama" type="text" placeholder="Nama pelanggan" />

      <label>Alamat</label>
      <input id="alamat" type="text" placeholder="Alamat (opsional)" />

      <label>No. WhatsApp</label>
      <input id="nowa" type="tel" placeholder="08xxxxxxxxxx" />

      <label>Catatan</label>
      <textarea id="ket" rows="2" placeholder="Jenis/berat/ket"></textarea>

      <label>Total (Rp)</label>
      <input id="total" type="number" placeholder="0" />

      <div class="row">
        <button id="saveBtn">Simpan ke Sheets</button>
        <button id="resetBtn" class="secondary">Reset Form</button>
      </div>

      <div id="saveMsg" class="muted"></div>

      <div id="previewArea" style="display:none;">
        <div class="preview thermal" id="previewBox"></div>

        <div class="controls">
          <button id="printBtn">Print</button>
          <button id="copyBtn" class="copy">Copy ke Clipboard</button>
          <button id="waBtn" class="secondary">Kirim via WhatsApp</button>
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:10px; font-size:12px;">
      Note: Sistem online, data tersimpan di Google Sheets pusat.
    </div>
  </div>

<script>
(() => {
  const APPS_URL = "https://script.google.com/macros/s/AKfycbxVWDTGgYeFLYXJS8xXIE88m0tBvBU0JDFK_nsKRxns-Ti2CDW3S_n9BZMVSEvFJC8h9Q/exec";
  
  const pinScreen = document.getElementById('pinScreen');
  const pinInput = document.getElementById('pinInput');
  const pinBtn = document.getElementById('pinBtn');
  const pinMsg = document.getElementById('pinMsg');
  const mainScreen = document.getElementById('mainScreen');
  const noEl = document.getElementById('no');
  const noStrukEl = document.getElementById('noStruk');
  const namaEl = document.getElementById('nama');
  const alamatEl = document.getElementById('alamat');
  const noWaEl = document.getElementById('nowa');
  const ketEl = document.getElementById('ket');
  const totalEl = document.getElementById('total');
  const saveBtn = document.getElementById('saveBtn');
  const resetBtn = document.getElementById('resetBtn');
  const saveMsg = document.getElementById('saveMsg');
  const previewArea = document.getElementById('previewArea');
  const previewBox = document.getElementById('previewBox');
  const printBtn = document.getElementById('printBtn');
  const waBtn = document.getElementById('waBtn');
  const copyBtn = document.getElementById('copyBtn');

  function qs(url){return fetch(url).then(r=>r.text());}
  function fmtCurrency(n){try{return Number(n).toLocaleString('id-ID');}catch{return n;}}
  function sanitizePhone(input){
    let s=String(input||'').replace(/\s+/g,'').replace(/[^0-9+]/g,'');
    if(s.startsWith('0')) s='62'+s.slice(1);
    if(!s.startsWith('62')&&!s.startsWith('+')) s='62'+s;
    return s.replace(/^\+/,'');
  }

  // ✅ Struk Basic (tanpa ucapan)
  function buildPreview(data){
    const lines=[];
    lines.push('================================');
    lines.push('       Rumah Nenek Laundry');
    lines.push('             Cariu');
    lines.push('Jl. Mashudi No. 10');
    lines.push('Samping Klinik Holistik');
    lines.push('--------------------------------');
    lines.push('No Struk : '+data.noStruk);
    lines.push('Nama     : '+data.nama);
    if(data.ket) lines.push('Catatan  : '+data.ket);
    lines.push('Total    : Rp '+fmtCurrency(data.total));
    lines.push('--------------------------------');
    lines.push('wa/dana  : 0895-6223-09251');
    lines.push('a.n.     : Tita Juarsih');
    lines.push('================================');
    return lines.join('\\n');
  }

  function showPreview(data){
    previewBox.textContent=buildPreview(data);
    previewArea.style.display='block';
  }

  function resetForm(){
    [namaEl,alamatEl,noWaEl,ketEl,totalEl].forEach(el=>el.value='');
    previewArea.style.display='none';
    saveMsg.textContent='';
  }

  async function checkPIN(pin){
    pinMsg.textContent='Memeriksa PIN...';
    try{
      const res=await qs(APPS_URL+'?action=checkPIN&pin='+encodeURIComponent(pin));
      if(res&&res.trim()==='OK'){pinMsg.textContent='PIN OK. Memuat nomor...';return true;}
      pinMsg.textContent='PIN salah.';return false;
    }catch(e){pinMsg.textContent='Gagal koneksi.';return false;}
  }

  async function getLast(){
    try{
      const raw=await qs(APPS_URL+'?action=getLast');
      return JSON.parse(raw);
    }catch(e){console.error(e);return null;}
  }

  async function saveData(payload){
    saveMsg.textContent='Menyimpan...';
    const params=new URLSearchParams();
    params.set('action','saveData');
    for(const [k,v] of Object.entries(payload)) params.set(k,v||'');
    try{
      const resText=await qs(APPS_URL+'?'+params.toString());
      saveMsg.textContent=resText||'SUKSES';
      return (resText&&resText.trim().toUpperCase().includes('OK'))||true;
    }catch(e){saveMsg.textContent='Gagal: '+(e.message||e);return false;}
  }

  pinBtn.addEventListener('click',async()=>{
    const pin=pinInput.value.trim();
    if(!pin){pinMsg.textContent='Masukkan PIN dulu.';return;}
    pinBtn.disabled=true;
    const ok=await checkPIN(pin);
    pinBtn.disabled=false;
    if(ok){
      pinScreen.style.display='none';
      mainScreen.style.display='block';
      const last=await getLast();
      if(last){noEl.value=last.no||'';noStrukEl.value=last.noStruk||'';}
      else{
        noEl.value='1';
        const d=new Date();
        noStrukEl.value=d.toLocaleDateString('id-ID').replace(/\D/g,'')+'-001';
      }
    }
  });

  saveBtn.addEventListener('click',async()=>{
    const data={
      no:noEl.value||'',
      noStruk:noStrukEl.value||'',
      nama:namaEl.value.trim(),
      alamat:alamatEl.value.trim(),
      no_wa:noWaEl.value.trim(),
      ket:ketEl.value.trim(),
      total:totalEl.value||0
    };
    if(!data.nama){saveMsg.textContent='Nama harus diisi.';return;}
    if(!data.total){saveMsg.textContent='Total harus diisi.';return;}
    saveBtn.disabled=true;
    const ok=await saveData(data);
    saveBtn.disabled=false;
    if(ok){
      showPreview(data);
      const nxt=await getLast();
      if(nxt){noEl.value=nxt.no||'';noStrukEl.value=nxt.noStruk||'';}
    }
  });

  resetBtn.addEventListener('click',()=>resetForm());
  printBtn.addEventListener('click',()=>window.print());
  waBtn.addEventListener('click',()=>{
    const text=previewBox.textContent||'';
    const phoneRaw=noWaEl.value.trim();
    if(!phoneRaw){alert('Nomor WA pelanggan kosong.');return;}
    const phone=sanitizePhone(phoneRaw);
    window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(text),'_blank');
  });
  copyBtn.addEventListener('click',()=>{
    navigator.clipboard.writeText(previewBox.textContent)
      .then(()=>alert('Teks struk disalin ke clipboard ✅'))
      .catch(()=>alert('Gagal menyalin teks.'));
  });
  pinInput.addEventListener('keyup',e=>{if(e.key==='Enter')pinBtn.click();});
  pinInput.focus();
})();
</script>
</body>
</html>