<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rumah Nenek Laundry</title>
<style>
  :root { font-family: Arial, sans-serif; color:#111; }
  body{ margin:0; padding:12px; background:#f7f7f7; -webkit-tap-highlight-color: transparent; }
  .card{ max-width:720px; width:95vw; margin:auto; background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06);}
  h2{ text-align:center; font-size:18px; margin-bottom:8px; }
  label{ font-size:13px; display:block; margin-top:8px; font-weight:600; }
  input,textarea{ width:100%; padding:10px; font-size:15px; box-sizing:border-box; border:1px solid #ddd; border-radius:8px; margin-top:6px; }
  button{ background:#00796b; color:#fff; border:none; padding:12px; border-radius:8px; font-size:15px; cursor:pointer; touch-action:manipulation; }
  button.secondary{ background:#6c757d; }
  button.danger{ background:#d32f2f; }
  .row{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
  .row > *{ flex:1; min-width:0; }
  .muted{ font-size:13px; color:#555; margin-top:8px; }
  .status{ margin-top:8px; padding:8px; border-radius:8px; font-weight:600; display:none; }
  .ok{ background:#e6ffef; color:#0b7a4a; display:block; }
  .warn{ background:#fff4e6; color:#b47a00; display:block; }
  .err{ background:#ffecec; color:#b32f2f; display:block; }
  .thermal{ width:280px; font-family:monospace; white-space:pre-wrap; background:#fff; border:1px dashed #222; padding:10px; border-radius:6px; margin:12px auto; }
  .results{ margin-top:10px; }
  .result-card{ border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:8px; background:#fafafa; font-size:13px; }
  .actions button{ margin-right:6px; margin-top:6px; }
  @media print {
    body *{ visibility:hidden; }
    .thermal, .thermal *{ visibility:visible; }
    .thermal{ position:absolute; left:0; top:0; width:58mm; font-size:11px; }
  }
</style>
</head>
<body>
<div class="card" role="application" aria-label="Rumah Nenek Laundry">
  <h2>ðŸ§º Rumah Nenek Laundry</h2>

  <!-- PIN -->
  <div id="pinScreen">
    <label for="pinInput">Masukkan PIN</label>
    <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN" autocomplete="off" />
    <div class="row">
      <button id="pinBtn">Masuk</button>
      <button id="pingBtn" class="secondary">Cek Server</button>
    </div>
    <div id="pinMsg" class="muted" role="status" aria-live="polite"></div>
  </div>

  <!-- MAIN -->
  <div id="mainScreen" style="display:none;">
    <label>No Urut</label>
    <input id="noUrut" type="text" readonly />

    <label>No Kwitansi</label>
    <input id="noKwitansi" type="text" readonly />

    <label>Nama Konsumen</label>
    <input id="nama" type="text" placeholder="Nama pelanggan" autocomplete="off" />

    <label>Alamat Konsumen</label>
    <input id="alamat" type="text" placeholder="Alamat (opsional)" />

    <label>No WA</label>
    <input id="nowa" type="tel" placeholder="08xxxxxxxxxx" inputmode="tel" />

    <label>Keterangan / Layanan</label>
    <textarea id="catatan" rows="2" placeholder="Misal: Cuci Kering, Setrika, Kilat"></textarea>

    <label>Total Harga (Rp)</label>
    <input id="total" type="number" placeholder="0" inputmode="numeric" />

    <div class="row">
      <button id="saveBtn">Simpan</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div id="statusBox" class="status muted" role="status" aria-live="polite"></div>

    <div id="previewArea" style="display:none; margin-top:10px;">
      <div class="thermal" id="previewBox" aria-hidden="false"></div>
      <div class="row">
        <button id="waBtn" class="secondary">Bagikan WA</button>
        <button id="copyBtn" class="secondary">Copy</button>
      </div>
    </div>

    <div class="results" id="results"></div>
  </div>
</div>

<script>
(() => {
  // CONFIG (gunakan exec yang kamu konfirmasi)
  const APPS_URL = "https://script.google.com/macros/s/AKfycbwZEEiXV5H7doeMZtc3seh1YkFH3xfD3TnnL9--3oMamu6lPeCBbzfAYS-1dsHhvzICog/exec";

  // ELEMS
  const $ = id => document.getElementById(id);
  const pinScreen = $('pinScreen'), pinInput = $('pinInput'), pinBtn = $('pinBtn'), pingBtn = $('pingBtn'), pinMsg = $('pinMsg');
  const mainScreen = $('mainScreen'), noUrutEl = $('noUrut'), noKwitEl = $('noKwitansi');
  const nama = $('nama'), alamat = $('alamat'), nowa = $('nowa'), catatan = $('catatan'), total = $('total');
  const saveBtn = $('saveBtn'), resetBtn = $('resetBtn'), statusBox = $('statusBox');
  const previewArea = $('previewArea'), previewBox = $('previewBox'), waBtn = $('waBtn'), copyBtn = $('copyBtn');
  const resultsBox = $('results');

  // HELPERS
  function setStatus(msg, kind){
    if(!msg){ statusBox.style.display='none'; statusBox.textContent=''; return; }
    statusBox.style.display='block';
    statusBox.textContent = msg;
    statusBox.className = 'status ' + (kind === 'ok' ? 'ok' : kind === 'err' ? 'err' : 'warn');
  }
  function safeJSON(txt){ try{return JSON.parse(txt);}catch(e){return null;} }
  async function fetchText(url, opts){ return fetch(url, opts).then(r=>r.text()); }
  async function fetchJSON(url, opts){
    const txt = await fetchText(url, opts);
    const j = safeJSON(txt);
    if(j !== null) return j;
    const t = txt.trim();
    if(t.toUpperCase() === 'OK') return { status:'success', message:'OK' };
    return { status:'error', message: t || 'Unknown response' };
  }
  function fmtIDR(n){ try { return Number(n||0).toLocaleString('id-ID'); } catch(e){ return n; } }

  function sanitizePhone(input){
    if(!input) return '';
    let s = String(input).replace(/\D/g,'');
    if(s.startsWith('0')) s = '62' + s.slice(1);
    if(!s.startsWith('62')) s = '62' + s;
    s = s.slice(0, 15);
    return s;
  }
  function isPhoneValidForWA(raw){
    const cleaned = sanitizePhone(raw);
    const digits = cleaned.replace(/\D/g,'');
    return digits.length >= 11 && digits.length <= 15;
  }

  // API wrappers (tolerant)
  async function checkPIN(pin){
    if(!pin) return { status:'error', message:'PIN kosong' };
    try { return await fetchJSON(APPS_URL + '?action=checkPIN&pin=' + encodeURIComponent(pin)); }
    catch(e){ return { status:'error', message:'Gagal koneksi' }; }
  }
  async function getLast(){
    try {
      const j = await fetchJSON(APPS_URL + '?action=getLast');
      if(j && j.data) return j.data;
      if(j && (j.noUrut || j.noKwitansi)) return { noUrut: j.noUrut, noKwitansi: j.noKwitansi };
      return {};
    } catch(e){ return {}; }
  }
  async function saveToServer(payload){
    try {
      const url = APPS_URL + '?action=save&data=' + encodeURIComponent(JSON.stringify(payload));
      return await fetchJSON(url);
    } catch(e){ return { status:'error', message:'Gagal koneksi' }; }
  }
  async function searchServer(q){
    try {
      const url = APPS_URL + '?action=search&q=' + encodeURIComponent(q);
      const j = await fetchJSON(url);
      if(j && j.hasil) return j.hasil;
      if(j && j.data) return j.data;
      if(Array.isArray(j)) return j;
      return [];
    } catch(e){ return []; }
  }
  async function deleteServer(noStruk){
    try {
      return await fetchJSON(APPS_URL + '?action=delete&noStruk=' + encodeURIComponent(noStruk));
    } catch(e){ return { status:'error', message:'Gagal koneksi' }; }
  }

  // Build preview text
  function buildPreviewText(d){
    return [
      '   RUMAH NENEK LAUNDRY',
      'Jl. Mashudi No 10 - Cariu',
      'WA/DANA 0895-6223-09251 a.n. Tita Juarsih',
      '----------------------------------',
      'No Struk   : ' + (d.No_Struk || ''),
      'No Urut    : ' + (d.No || ''),
      'Nama       : ' + (d.Nama || ''),
      d.Alamat ? ('Alamat     : ' + d.Alamat) : '',
      d.No_WA ? ('WA         : ' + d.No_WA) : '',
      d.Keterangan ? ('Keterangan : ' + d.Keterangan) : '',
      '----------------------------------',
      'Total      : Rp ' + fmtIDR(d.Total || 0),
      '----------------------------------',
      new Date().toLocaleString('id-ID')
    ].filter(Boolean).join('\n');
  }

  // PIN login
  pinBtn.addEventListener('click', async ()=>{
    setStatus('Memeriksa PIN...', 'warn');
    const res = await checkPIN(pinInput.value.trim());
    if(res && (res.status === 'success' || (res.message && String(res.message).toLowerCase().includes('ok')))){
      setStatus('PIN valid. Memuat nomor...', 'ok');
      pinScreen.style.display = 'none';
      mainScreen.style.display = 'block';
      const last = await getLast();
      if(last.noUrut) noUrutEl.value = last.noUrut;
      if(last.noKwitansi) noKwitEl.value = last.noKwitansi;
      setStatus('', '');
    } else {
      setStatus(res && res.message ? res.message : 'PIN salah', 'err');
    }
  });

  pingBtn.addEventListener('click', async ()=>{
    setStatus('Memeriksa server...', 'warn');
    try {
      const j = await fetchJSON(APPS_URL + '?action=ping');
      setStatus('Server merespon', 'ok');
    } catch(e){ setStatus('Server tidak merespon', 'err'); }
  });

  // SAVE: full-online; after success -> keep preview, disable Save, do NOT auto-refresh numbers
  saveBtn.addEventListener('click', async (ev)=>{
    ev.preventDefault();
    setStatus('', '');
    const nameVal = (nama.value||'').trim();
    const totalVal = (total.value||'').toString().trim();
    if(!nameVal || nameVal.length < 2){ setStatus('Nama minimal 2 karakter', 'err'); nama.focus(); return; }
    if(!totalVal || isNaN(Number(totalVal)) || Number(totalVal) <= 0){ setStatus('Total harus angka > 0', 'err'); total.focus(); return; }
    if(nowa.value && !isPhoneValidForWA(nowa.value)){ setStatus('Nomor WA tidak valid (format 08... atau +62...)', 'err'); nowa.focus(); return; }

    const payload = {
      No: noUrutEl.value || '',
      No_Struk: noKwitEl.value || '',
      Nama: nameVal,
      Alamat: (alamat.value||'').trim(),
      No_WA: sanitizePhone(nowa.value),
      Keterangan: (catatan.value||'').trim(),
      Total: Number(totalVal),
      Tanggal: new Date().toLocaleString('id-ID')
    };

    previewBox.textContent = buildPreviewText(payload);
    previewArea.style.display = 'block';
    previewBox.scrollIntoView({behavior:'smooth', block:'center'});

    setStatus('Menyimpan ke server...', 'warn');
    // Save
    const res = await saveToServer(payload);
    if(res && (res.status === 'success' || (res.message && (String(res.message).toLowerCase().includes('sukses') || String(res.message).toLowerCase().includes('ok'))))){
      setStatus('âœ… Data tersimpan online. Silakan Bagikan WA atau Copy. Tekan Reset untuk entri baru.', 'ok');
      // disable save to prevent duplicate
      saveBtn.disabled = true;
      // optionally attempt best-effort backup (no harm if backend not support)
      try { fetch(APPS_URL + '?action=saveLog&data=' + encodeURIComponent(JSON.stringify({payload,ts:new Date().toISOString()}))).catch(()=>{}); } catch(e){}
    } else {
      setStatus((res && res.message) ? res.message : 'Gagal menyimpan (server)', 'err');
    }
  });

  // Reset -> begin new entry: fetch getLast to refresh No & No_Struk, clear inputs, enable Save
  resetBtn.addEventListener('click', async ()=>{
    if(!confirm('Mulai entri baru? (ini akan bersihkan form dan ambil nomor berikutnya)')) return;
    nama.value = ''; alamat.value = ''; nowa.value = ''; catatan.value = ''; total.value = '';
    previewArea.style.display = 'none';
    saveBtn.disabled = false;
    setStatus('Memuat nomor baru...', 'warn');
    const last = await getLast();
    if(last.noUrut) noUrutEl.value = last.noUrut;
    if(last.noKwitansi) noKwitEl.value = last.noKwitansi;
    setStatus('', '');
    // focus ke nama untuk input cepat
    nama.focus();
  });

  // WA & Copy work on preview; since preview is kept after save, user can click immediately
  waBtn.addEventListener('click', ()=>{
    const txt = previewBox.textContent || '';
    if(!txt){ alert('Tidak ada struk untuk dibagikan.'); return; }
    if(!isPhoneValidForWA(nowa.value)){ alert('Nomor WA tidak valid.'); return; }
    const phone = sanitizePhone(nowa.value);
    window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(txt), '_blank');
  });

  copyBtn.addEventListener('click', ()=>{
    const txt = previewBox.textContent || '';
    if(!txt){ setStatus('Tidak ada struk untuk disalin', 'warn'); return; }
    navigator.clipboard.writeText(txt).then(()=> setStatus('Struk disalin ke clipboard', 'ok')).catch(()=> setStatus('Gagal salin', 'err'));
  });

  // Quick search with Ctrl/Cmd+F prompt (ke Apps Script 'search')
  document.addEventListener('keydown', (ev)=>{
    if((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 'f'){
      ev.preventDefault();
      const q = prompt('Cari No/No_Struk/Nama/No_WA:');
      if(q !== null && q.trim() !== '') runSearch(q.trim());
    }
  });

  async function runSearch(q){
    setStatus('Mencari: "'+q+'" ...', 'warn');
    resultsBox.innerHTML = '';
    const data = await searchServer(q);
    if(!data || data.length === 0){ setStatus('Tidak ada hasil untuk "'+q+'"', 'err'); return; }
    setStatus('Hasil ditemukan: '+data.length, 'ok');
    resultsBox.innerHTML = '';
    data.forEach((r) => {
      let row = {};
      if(Array.isArray(r)){
        row = { No: r[0], No_Struk: r[1], Nama: r[2], Alamat: r[3], No_WA: r[4], Keterangan: r[5], Total: r[6], Tanggal: r[7] };
      } else { row = r; }
      const card = document.createElement('div');
      card.className = 'result-card';
      const previewText = buildPreviewText(row);
      // build buttons with safe handlers
      card.innerHTML = `<b>${row.Nama || ''}</b><br>
        No: ${row.No || ''} | ${row.No_Struk || ''}<br>
        Total: Rp ${fmtIDR(row.Total || row.Total_Harga || 0)}<br>
        <small>${row.Tanggal ? row.Tanggal : ''}</small>
        <div style="margin-top:8px;" class="actions">
          <button class="secondary copyResult">Bagikan WA</button>
          <button class="danger delResult">Hapus</button>
          <button class="secondary doCopy">Copy</button>
        </div>`;
      resultsBox.appendChild(card);
      // attach event listeners
      const copyBtns = card.querySelectorAll('.doCopy');
      copyBtns.forEach(btn => btn.addEventListener('click', ()=>{ navigator.clipboard.writeText(previewText); setStatus('Struk disalin ke clipboard', 'ok'); }));
      const shareBtns = card.querySelectorAll('.copyResult');
      shareBtns.forEach(btn => btn.addEventListener('click', ()=>{ 
        if(!isPhoneValidForWA(row.No_WA)){ alert('Nomor WA di struk tidak valid'); return; }
        const phone = sanitizePhone(row.No_WA);
        window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(previewText), '_blank');
      }));
      const delBtns = card.querySelectorAll('.delResult');
      delBtns.forEach(btn => btn.addEventListener('click', async ()=>{
        if(!confirm('Hapus struk '+(row.No_Struk||'')+' ?')) return;
        setStatus('Menghapus...', 'warn');
        const res = await deleteServer(row.No_Struk || '');
        if(res && (res.status === 'success' || (res.message && String(res.message).toLowerCase().includes('ok')))){
          setStatus('Struk dibatalkan (safe).', 'ok');
          card.remove();
        } else setStatus((res && res.message) ? res.message : 'Gagal hapus', 'err');
      }));
    });
  }

  // init: load last numbers
  (async function init(){
    setStatus('Memuat...', 'warn');
    const last = await getLast();
    if(last.noUrut) noUrutEl.value = last.noUrut;
    if(last.noKwitansi) noKwitEl.value = last.noKwitansi;
    setStatus('', '');
  })();

  // prevent Enter auto-submit (allow newline in textarea)
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && (document.activeElement && ['INPUT','TEXTAREA'].includes(document.activeElement.tagName))){
      if(document.activeElement.id !== 'catatan') e.preventDefault();
    }
  });

})();
</script>
</body>
</html>