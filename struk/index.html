<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rumah Nenek Laundry</title>
<style>
  :root{font-family:Arial,Helvetica,sans-serif;color:#111}
  body{margin:0;padding:12px;background:#f7f7f7;-webkit-tap-highlight-color:transparent}
  .card{max-width:720px;width:95vw;margin:auto;background:#fff;padding:14px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.06)}
  h2{text-align:center;margin:0 0 8px;font-size:18px}
  label{display:block;margin-top:8px;font-weight:600;font-size:13px}
  input,textarea,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:6px;font-size:15px;box-sizing:border-box}
  button{background:#00796b;color:#fff;border:0;padding:12px;border-radius:10px;font-size:15px;cursor:pointer}
  button.secondary{background:#6c757d}
  button.danger{background:#d32f2f}
  .row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .row> *{flex:1;min-width:0}
  .muted{font-size:13px;color:#555;margin-top:8px}
  .status{margin-top:8px;padding:8px;border-radius:8px;font-weight:600;display:none}
  .ok{background:#e6ffef;color:#0b7a4a}
  .warn{background:#fff4e6;color:#b47a00}
  .err{background:#ffecec;color:#b32f2f}
  .thermal{width:280px;font-family:monospace;white-space:pre-wrap;background:#fff;border:1px dashed #222;padding:10px;border-radius:6px;margin:12px auto}
  .results{margin-top:12px}
  .result-card{border:1px solid #e6e6e6;border-radius:8px;padding:10px;margin-bottom:10px;background:#fff;font-size:14px}
  .result-row{display:flex;gap:6px;flex-wrap:wrap}
  .small-btn{padding:8px 10px;border-radius:8px;font-size:13px}
  .inline-input{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;margin-top:6px;width:100%}
  .label-muted{font-size:12px;color:#666;margin-top:6px}
  @media print{body *{visibility:hidden}.thermal, .thermal *{visibility:visible}.thermal{position:absolute;left:0;top:0;width:58mm;font-size:11px}}
</style>
</head>
<body>
<div class="card" aria-label="Rumah Nenek Laundry">
  <h2>ðŸ§º Rumah Nenek Laundry</h2>

  <!-- PIN -->
  <div id="pinScreen">
    <label for="pinInput">Masukkan PIN</label>
    <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN" autocomplete="off" />
    <div class="row">
      <button id="pinBtn">Masuk</button>
      <button id="pingBtn" class="secondary">Cek Server</button>
    </div>
    <div id="pinMsg" class="muted" role="status" aria-live="polite"></div>
  </div>

  <!-- MAIN -->
  <div id="mainScreen" style="display:none;">

    <label>No Urut</label>
    <input id="noUrut" readonly />

    <label>No Kwitansi</label>
    <input id="noKwitansi" readonly />

    <label>Nama Konsumen</label>
    <input id="nama" placeholder="Nama pelanggan" />

    <label>Alamat Konsumen</label>
    <input id="alamat" placeholder="Alamat (opsional)" />

    <label>No WA</label>
    <input id="nowa" placeholder="08xxxxxxxxxx" inputmode="tel" />

    <label>Keterangan / Layanan</label>
    <textarea id="catatan" rows="2" placeholder="Misal: Cuci Kering, Setrika, Kilat"></textarea>

    <label>Total Harga (Rp)</label>
    <input id="total" type="number" placeholder="0" inputmode="numeric" />

    <div class="row">
      <button id="saveBtn">Simpan</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div id="statusBox" class="status" role="status" aria-live="polite"></div>

    <div id="previewArea" style="display:none;margin-top:12px">
      <div class="thermal" id="previewBox"></div>
      <div class="row">
        <button id="waBtn" class="secondary">Bagikan WA</button>
        <button id="copyBtn" class="secondary">Copy</button>
      </div>
    </div>

    <!-- SEARCH area -->
    <div style="margin-top:14px;">
      <label>Cari Struk Lama</label>
      <input id="searchInput" placeholder="Ketik No / No_Struk / Nama / No_WA lalu tekan Enter" />
      <div class="label-muted">Tekan Enter untuk mencari. Hasil muncul di bawah.</div>
    </div>

    <div class="results" id="results"></div>
  </div>
</div>

<script>
(() => {
  // CONFIG: gunakan URL Apps Script yang sudah kamu deploy
  const APPS_URL = "https://script.google.com/macros/s/AKfycbwZEEiXV5H7doeMZtc3seh1YkFH3xfD3TnnL9--3oMamu6lPeCBbzfAYS-1dsHhvzICog/exec";

  // ELEMENTS
  const $ = id => document.getElementById(id);
  const pinScreen = $('pinScreen'), pinInput = $('pinInput'), pinBtn = $('pinBtn'), pingBtn = $('pingBtn'), pinMsg = $('pinMsg');
  const mainScreen = $('mainScreen'), noUrutEl = $('noUrut'), noKwitEl = $('noKwitansi');
  const nama = $('nama'), alamat = $('alamat'), nowa = $('nowa'), catatan = $('catatan'), total = $('total');
  const saveBtn = $('saveBtn'), resetBtn = $('resetBtn'), statusBox = $('statusBox');
  const previewArea = $('previewArea'), previewBox = $('previewBox'), waBtn = $('waBtn'), copyBtn = $('copyBtn');
  const searchInput = $('searchInput'), resultsBox = $('results');

  // HELPERS
  function setStatus(msg, kind){
    if(!msg){ statusBox.style.display='none'; statusBox.textContent=''; return; }
    statusBox.style.display='block';
    statusBox.textContent = msg;
    statusBox.className = 'status ' + (kind === 'ok' ? 'ok' : kind === 'err' ? 'err' : 'warn');
  }
  function safeJSON(txt){ try { return JSON.parse(txt); } catch(e){ return null; } }
  async function fetchText(url, opts){ return fetch(url, opts).then(r=>r.text()); }
  async function fetchJSON(url, opts){
    const txt = await fetchText(url, opts);
    const j = safeJSON(txt);
    if(j !== null) return j;
    const t = txt.trim();
    if(t.toUpperCase()==='OK') return { status:'success', message:'OK' };
    return { status:'error', message: t || 'Unknown response' };
  }
  function fmtIDR(n){ try{return Number(n||0).toLocaleString('id-ID')}catch(e){return n} }

  function sanitizePhone(input){
    if(!input) return '';
    let s = String(input).replace(/\D/g,'');
    if(s.startsWith('0')) s = '62' + s.slice(1);
    if(!s.startsWith('62')) s = '62' + s;
    return s.slice(0,15);
  }
  function isPhoneValidForWA(raw){
    const c = sanitizePhone(raw);
    const d = c.replace(/\D/g,'');
    return d.length >= 11 && d.length <= 15;
  }

  // API wrappers
  async function api_checkPIN(pin){
    if(!pin) return { status:'error', message:'PIN kosong' };
    try { return await fetchJSON(APPS_URL + '?action=checkPIN&pin=' + encodeURIComponent(pin)); } catch(e){ return { status:'error', message:'Gagal koneksi' }; }
  }
  async function api_getLast(){
    try {
      const j = await fetchJSON(APPS_URL + '?action=getLast');
      if(j && j.data) return j.data;
      if(j && (j.noUrut || j.noKwitansi)) return { noUrut:j.noUrut, noKwitansi:j.noKwitansi };
      return {};
    } catch(e){ return {}; }
  }
  async function api_save(payload){
    try {
      const url = APPS_URL + '?action=save&data=' + encodeURIComponent(JSON.stringify(payload));
      return await fetchJSON(url);
    } catch(e){ return { status:'error', message:'Gagal koneksi' }; }
  }
  async function api_search(q){
    try {
      const url = APPS_URL + '?action=search&q=' + encodeURIComponent(q);
      const j = await fetchJSON(url);
      if(j && j.hasil) return j.hasil;
      if(j && j.data) return j.data;
      if(Array.isArray(j)) return j;
      return [];
    } catch(e){ return []; }
  }
  async function api_delete(noStruk){
    try { return await fetchJSON(APPS_URL + '?action=delete&noStruk=' + encodeURIComponent(noStruk)); }
    catch(e){ return { status:'error', message:'Gagal koneksi' }; }
  }
  async function api_edit(p){
    // try calling editData (some backends expose editData)
    try { return await fetchJSON(APPS_URL + '?action=editData&' + new URLSearchParams(p)); }
    catch(e){ return { status:'error', message:'Gagal koneksi' }; }
  }

  // PREVIEW builder
  function buildPreview(row){
    return [
      '   RUMAH NENEK LAUNDRY',
      'Jl. Mashudi No 10 - Cariu',
      'WA/DANA 0895-6223-09251 a.n. Tita Juarsih',
      '----------------------------------',
      'No Struk   : ' + (row.No_Struk || ''),
      'No Urut    : ' + (row.No || ''),
      'Nama       : ' + (row.Nama || ''),
      row.Alamat ? 'Alamat     : ' + row.Alamat : '',
      row.No_WA ? 'WA         : ' + row.No_WA : '',
      row.Keterangan ? 'Keterangan : ' + row.Keterangan : '',
      '----------------------------------',
      'Total      : Rp ' + fmtIDR(row.Total || 0),
      '----------------------------------',
      new Date().toLocaleString('id-ID')
    ].filter(Boolean).join('\n');
  }

  // LOGIN PIN
  pinBtn.addEventListener('click', async ()=>{
    setStatus('Memeriksa PIN...', 'warn');
    const res = await api_checkPIN(pinInput.value.trim());
    if(res && (res.status === 'success' || (res.message && String(res.message).toLowerCase().includes('ok')))){
      setStatus('PIN valid. Memuat nomor...', 'ok');
      pinScreen.style.display = 'none';
      mainScreen.style.display = 'block';
      const last = await api_getLast();
      if(last.noUrut) noUrutEl.value = last.noUrut;
      if(last.noKwitansi) noKwitEl.value = last.noKwitansi;
      setStatus('', '');
      nama.focus();
    } else {
      setStatus(res && res.message ? res.message : 'PIN salah', 'err');
    }
  });

  pingBtn.addEventListener('click', async ()=>{
    setStatus('Memeriksa server...', 'warn');
    try { await fetchJSON(APPS_URL + '?action=ping'); setStatus('Server merespon', 'ok') } catch(e){ setStatus('Server tidak merespon', 'err') }
  });

  // SAVE
  saveBtn.addEventListener('click', async (ev)=>{
    ev.preventDefault();
    setStatus('', '');
    const namaVal = (nama.value||'').trim();
    const totalVal = (total.value||'').toString().trim();
    if(!namaVal || namaVal.length < 2){ setStatus('Nama minimal 2 karakter', 'err'); nama.focus(); return; }
    if(!totalVal || isNaN(Number(totalVal)) || Number(totalVal) <= 0){ setStatus('Total harus angka > 0', 'err'); total.focus(); return; }
    if(nowa.value && !isPhoneValidForWA(nowa.value)){ setStatus('Nomor WA tidak valid', 'err'); nowa.focus(); return; }

    const payload = {
      No: noUrutEl.value || '',
      No_Struk: noKwitEl.value || '',
      Nama: namaVal,
      Alamat: (alamat.value||'').trim(),
      No_WA: sanitizePhone(nowa.value),
      Keterangan: (catatan.value||'').trim(),
      Total: Number(totalVal),
      Tanggal: new Date().toLocaleString('id-ID')
    };

    previewBox.textContent = buildPreview(payload);
    previewArea.style.display = 'block';
    previewBox.scrollIntoView({behavior:'smooth',block:'center'});

    setStatus('Menyimpan ke server...', 'warn');
    const res = await api_save(payload);
    if(res && (res.status === 'success' || (res.message && (String(res.message).toLowerCase().includes('sukses') || String(res.message).toLowerCase().includes('ok'))))){
      setStatus('âœ… Data tersimpan online. Silakan Bagikan WA atau Copy. Tekan Reset untuk entri baru.', 'ok');
      saveBtn.disabled = true;
      // best-effort: try to call saveLog (if backend supports)
      try { fetch(APPS_URL + '?action=saveLog&data=' + encodeURIComponent(JSON.stringify({payload,ts:new Date().toISOString()}))).catch(()=>{}); } catch(e){}
    } else {
      setStatus((res && res.message) ? res.message : 'Gagal menyimpan (server)', 'err');
    }
  });

  // RESET - fetch new numbers and clear form
  resetBtn.addEventListener('click', async ()=>{
    if(!confirm('Mulai entri baru? (ini akan bersihkan form dan ambil nomor berikutnya)')) return;
    nama.value = ''; alamat.value = ''; nowa.value = ''; catatan.value = ''; total.value = '';
    previewArea.style.display = 'none';
    saveBtn.disabled = false;
    setStatus('Memuat nomor baru...', 'warn');
    const last = await api_getLast();
    if(last.noUrut) noUrutEl.value = last.noUrut;
    if(last.noKwitansi) noKwitEl.value = last.noKwitansi;
    setStatus('', '');
    nama.focus();
  });

  // WA / COPY for current preview
  waBtn.addEventListener('click', ()=>{
    const txt = previewBox.textContent || '';
    if(!txt){ alert('Tidak ada struk untuk dibagikan.'); return; }
    if(!isPhoneValidForWA(nowa.value)){ alert('Nomor WA tidak valid.'); return; }
    const phone = sanitizePhone(nowa.value);
    window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(txt), '_blank');
  });
  copyBtn.addEventListener('click', ()=>{
    const txt = previewBox.textContent || '';
    if(!txt){ setStatus('Tidak ada struk untuk disalin', 'warn'); return; }
    navigator.clipboard.writeText(txt).then(()=> setStatus('Struk disalin ke clipboard', 'ok')).catch(()=> setStatus('Gagal salin', 'err'));
  });

  // SEARCH - press Enter in searchInput
  searchInput.addEventListener('keydown', async (e)=>{
    if(e.key === 'Enter'){
      const q = (searchInput.value||'').trim();
      if(!q){ setStatus('Query kosong', 'warn'); return; }
      setStatus('Mencari: "'+q+'" ...', 'warn');
      resultsBox.innerHTML = '';
      const data = await api_search(q);
      if(!data || data.length === 0){ setStatus('Tidak ada hasil untuk "'+q+'"', 'err'); return; }
      setStatus('Hasil ditemukan: '+data.length, 'ok');
      renderResults(data);
    }
  });

  // render results with inline edit, delete, share, copy
  function renderResults(list){
    resultsBox.innerHTML = '';
    list.forEach((r)=>{
      // normalize row: sheet returns array or object
      let row = {};
      if(Array.isArray(r)){
        row = { No:r[0], No_Struk:r[1], Nama:r[2], Alamat:r[3], No_WA:r[4], Keterangan:r[5], Total:r[6], Tanggal:r[7] };
      } else { row = r; }
      const card = document.createElement('div');
      card.className = 'result-card';
      // build inline editable fields
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><b>${row.Nama || ''}</b><div class="label-muted">${row.No_Struk||''} â€¢ ${row.Tanggal||''}</div></div>
          <div style="text-align:right"><div style="font-weight:700">Rp ${fmtIDR(row.Total||0)}</div></div>
        </div>
        <div style="margin-top:8px" class="result-row">
          <input class="inline-input nameField" value="${(row.Nama||'').toString().replace(/"/g,'&quot;')}" />
          <input class="inline-input waField" value="${(row.No_WA||'').toString().replace(/"/g,'&quot;')}" />
        </div>
        <div style="margin-top:8px" class="result-row">
          <input class="inline-input alamatField" value="${(row.Alamat||'').toString().replace(/"/g,'&quot;')}" />
          <input class="inline-input totalField" value="${(row.Total||'').toString().replace(/"/g,'&quot;')}" />
        </div>
        <div style="margin-top:8px" class="label-muted">Keterangan</div>
        <textarea class="inline-input catField" rows="2">${(row.Keterangan||'').toString().replace(/</g,'&lt;')}</textarea>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="small-btn saveEditBtn">Simpan Edit</button>
          <button class="small-btn danger delBtn">Hapus</button>
          <button class="small-btn secondary shareBtn">Bagikan WA</button>
          <button class="small-btn secondary copyBtn">Copy</button>
        </div>
      `;
      resultsBox.appendChild(card);

      // attach handlers
      const nameF = card.querySelector('.nameField');
      const waF = card.querySelector('.waField');
      const alamatF = card.querySelector('.alamatField');
      const totalF = card.querySelector('.totalField');
      const catF = card.querySelector('.catField');
      const saveEditBtn = card.querySelector('.saveEditBtn');
      const delBtn = card.querySelector('.delBtn');
      const shareBtn = card.querySelector('.shareBtn');
      const copyBtn = card.querySelector('.copyBtn');

      // Save Edit -> call api_edit
      saveEditBtn.addEventListener('click', async ()=>{
        const newName = (nameF.value||'').trim();
        const newWA = (waF.value||'').trim();
        const newAlamat = (alamatF.value||'').trim();
        const newTotal = (totalF.value||'').trim();
        const newCat = (catF.value||'').trim();
        if(!newName || newName.length<2){ alert('Nama minimal 2 karakter'); nameF.focus(); return; }
        if(!newTotal || isNaN(Number(newTotal))){ alert('Total harus angka'); totalF.focus(); return; }
        if(newWA && !isPhoneValidForWA(newWA)){ alert('Nomor WA tidak valid'); waF.focus(); return; }

        if(!confirm('Simpan perubahan pada struk '+(row.No_Struk||'')+' ?')) return;
        setStatus('Menyimpan perubahan...', 'warn');
        // try editData with params: No_Struk or No
        const params = {
          No_Struk: row.No_Struk || row.NoKwit || '',
          nama: newName,
          alamat: newAlamat,
          nowa: sanitizePhone(newWA),
          keterangan: newCat,
          total: newTotal
        };
        const res = await api_edit(params);
        if(res && res.status === 'success'){
          setStatus('Perubahan tersimpan', 'ok');
          // update card display quickly
          nameF.value = newName; waF.value = sanitizePhone(newWA); alamatF.value = newAlamat; totalF.value = newTotal; catF.value = newCat;
        } else {
          setStatus((res && res.message) ? res.message : 'Gagal menyimpan perubahan', 'err');
        }
      });

      // Delete
      delBtn.addEventListener('click', async ()=>{
        if(!confirm('Hapus struk '+(row.No_Struk||'')+' ?')) return;
        setStatus('Menghapus...', 'warn');
        const res = await api_delete(row.No_Struk || row.NoKwit || '');
        if(res && res.status === 'success'){
          setStatus('Struk dibatalkan (safe).', 'ok');
          card.remove();
        } else {
          setStatus((res && res.message) ? res.message : 'Gagal hapus', 'err');
        }
      });

      // Share specific record (use WA in the record if present)
      shareBtn.addEventListener('click', ()=>{
        const previewText = buildPreview({
          No: row.No, No_Struk: row.No_Struk, Nama: nameF.value, Alamat: alamatF.value,
          No_WA: waF.value, Keterangan: catF.value, Total: totalF.value
        });
        const phoneRaw = waF.value || row.No_WA || '';
        if(!isPhoneValidForWA(phoneRaw)){ alert('Nomor WA tidak valid'); return; }
        const phone = sanitizePhone(phoneRaw);
        window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(previewText), '_blank');
      });

      // Copy
      copyBtn.addEventListener('click', ()=>{
        const previewText = buildPreview({
          No: row.No, No_Struk: row.No_Struk, Nama: nameF.value, Alamat: alamatF.value,
          No_WA: waF.value, Keterangan: catF.value, Total: totalF.value
        });
        navigator.clipboard.writeText(previewText).then(()=> setStatus('Struk disalin ke clipboard', 'ok')).catch(()=> setStatus('Gagal salin', 'err'));
      });
    });
  }

  // INIT
  (async function init(){
    setStatus('Memuat...', 'warn');
    const last = await api_getLast();
    if(last.noUrut) noUrutEl.value = last.noUrut;
    if(last.noKwitansi) noKwitEl.value = last.noKwitansi;
    setStatus('', '');
  })();

  // prevent Enter from submitting when focus in non-search fields
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && document.activeElement && document.activeElement.id !== 'searchInput' && document.activeElement.tagName !== 'TEXTAREA'){
      e.preventDefault();
    }
  });

})();
</script>
</body>
</html>