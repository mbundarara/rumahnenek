<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rumah Nenek Laundry</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
  .card { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:20px; }
  label { display:block; margin-top:8px; font-weight:bold; }
  input, textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-top:4px; }
  button { padding:10px 15px; border:none; border-radius:6px; margin:5px 0; }
  .btn { background:#007bff; color:white; }
  .btn-danger { background:#dc3545; color:white; }
  .hidden { display:none; }
  small { color:#555; font-size:0.8em; }
</style>
</head>
<body>

<div id="pinScreen" class="card">
  <h3>Masukkan PIN</h3>
  <input id="pinInput" type="password" placeholder="PIN">
  <button id="pinBtn" class="btn">Masuk</button>
  <p id="pinMsg"></p>
</div>

<div id="mainScreen" class="card hidden">
  <h3>Input Struk</h3>

  <label>No Urut</label>
  <input id="noUrut" readonly>

  <label>No Struk</label>
  <input id="noKwitansi" readonly>

  <label>Nama Konsumen</label>
  <input id="nama">

  <label>Alamat</label>
  <input id="alamat">

  <label>No WA</label>
  <input id="wa">

  <label>Keterangan</label>
  <textarea id="catatan"></textarea>

  <label>Total Harga</label>
  <input id="total" type="number">

  <button id="saveBtn" class="btn">Simpan</button>
  <button id="resetBtn">Reset</button>

  <hr>

  <h3>Cari Struk</h3>
  <input id="searchInput" placeholder="Cari berdasarkan No, Nama, WA, dst">
  <button id="searchBtn" class="btn">Cari</button>

  <ul id="searchResult"></ul>
</div>

<script>
const APPS_URL = "https://script.google.com/macros/s/AKfycbwZEEiXV5H7doeMZtc3seh1YkFH3xfD3TnnL9--3oMamu6lPeCBbzfAYS-1dsHhvzICog/exec";

// Elemen
const pinScreen = document.getElementById('pinScreen');
const mainScreen = document.getElementById('mainScreen');
const pinInput = document.getElementById('pinInput');
const pinBtn = document.getElementById('pinBtn');
const pinMsg = document.getElementById('pinMsg');
const noUrut = document.getElementById('noUrut');
const noKwitansi = document.getElementById('noKwitansi');
const nama = document.getElementById('nama');
const alamat = document.getElementById('alamat');
const wa = document.getElementById('wa');
const catatan = document.getElementById('catatan');
const total = document.getElementById('total');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const searchBtn = document.getElementById('searchBtn');
const searchInput = document.getElementById('searchInput');
const searchResult = document.getElementById('searchResult');

// --- CEK PIN ---
pinBtn.onclick = async ()=>{
  pinMsg.textContent='Memeriksa...';
  try {
    const res = await fetch(APPS_URL+'?action=checkPIN&pin='+encodeURIComponent(pinInput.value));
    const data = await res.json();
    if(data.status==='success'){
      pinScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      await refreshNomor();
    } else {
      pinMsg.textContent='PIN salah!';
    }
  } catch(err){
    pinMsg.textContent='Gagal konek server.';
  }
};

// --- REFRESH NOMOR ---
async function refreshNomor(){
  const res = await fetch(APPS_URL+'?action=getLast').then(r=>r.json());
  noUrut.value = res.data.noUrut;
  noKwitansi.value = res.data.noKwitansi;
}

// --- SIMPAN DATA ---
saveBtn.onclick = async ()=>{
  if(!nama.value){ alert('Nama wajib diisi!'); return; }
  if(!confirm('Simpan data ini?')) return;

  const payload = {
    No: noUrut.value,
    No_Struk: noKwitansi.value,
    Nama: nama.value,
    Alamat: alamat.value,
    No_WA: wa.value,
    Keterangan: catatan.value,
    Total: total.value,
    Tanggal: new Date().toLocaleDateString('id-ID')
  };

  const res = await fetch(APPS_URL+'?action=save&data='+encodeURIComponent(JSON.stringify(payload)));
  const data = await res.json();
  alert(data.message);
  if(data.status==='success') { resetForm(); refreshNomor(); }
};

// --- RESET FORM ---
function resetForm(){
  nama.value = alamat.value = wa.value = catatan.value = total.value = '';
}

// --- CARI DATA ---
searchBtn.onclick = async ()=>{
  searchResult.innerHTML = 'Mencari...';
  const res = await fetch(APPS_URL+'?action=search&q='+encodeURIComponent(searchInput.value));
  const data = await res.json();
  if(data.status==='success'){
    searchResult.innerHTML = '';
    data.hasil.forEach(row=>{
      const li = document.createElement('li');
      li.textContent = row.join(' | ');
      searchResult.appendChild(li);
    });
  } else searchResult.innerHTML='Tidak ditemukan';
};
</script>

</body>
</html>