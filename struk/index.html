<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rumah Nenek Laundry</title>
<style>
  :root { font-family: 'Segoe UI', sans-serif; color:#222; }
  body { margin:0; padding:12px; background:#f7f7f7; }
  .card { max-width:420px; margin:auto; background:#fff; padding:18px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  h2 { text-align:center; font-size:18px; margin-bottom:8px; color:#056; }
  label { display:block; font-size:14px; margin-top:10px; font-weight:600; }
  input, textarea, select {
    width:100%; padding:10px; font-size:15px;
    border:1px solid #ccc; border-radius:8px; box-sizing:border-box;
    margin-top:4px;
  }
  button {
    width:100%; padding:12px; font-size:15px; font-weight:600;
    border:none; border-radius:8px; margin-top:10px; cursor:pointer;
  }
  button.primary { background:#0a8f8f; color:#fff; }
  button.secondary { background:#555; color:#fff; }
  .muted { font-size:13px; color:#777; margin-top:6px; text-align:center; }
  .thermal { font-family:monospace; background:#fff; border:1px dashed #000; border-radius:6px; padding:8px; margin-top:10px; white-space:pre-wrap; }
  .row { display:flex; gap:8px; }
  .row button { flex:1; }
  .result-card {
    background:#fafafa; border:1px solid #ddd; border-radius:6px;
    padding:8px; margin-top:8px; font-size:14px;
  }
  @media (max-width:480px){
    body{padding:8px;}
    input,textarea,button{font-size:14px;}
  }
</style>
</head>
<body>
<div class="card">
  <h2>Rumah Nenek Laundry</h2>

  <!-- STEP 1: PIN -->
  <div id="pinScreen">
    <label>Masukkan PIN</label>
    <input id="pinInput" type="password" placeholder="PIN Akses">
    <button id="pinBtn" class="primary">Masuk</button>
    <div id="pinMsg" class="muted"></div>
  </div>

  <!-- STEP 2: FORM INPUT -->
  <div id="mainScreen" style="display:none;">
    <label>No Urut</label>
    <input id="noUrut" type="text" readonly>

    <label>No Struk</label>
    <input id="noKwitansi" type="text" readonly>

    <label>Nama Pelanggan</label>
    <input id="nama" type="text" placeholder="Masukkan nama pelanggan">

    <label>Alamat</label>
    <input id="alamat" type="text" placeholder="Masukkan alamat (opsional)">

    <label>No WA</label>
    <input id="nowa" type="tel" placeholder="08xxxxxxxxxx">

    <label>Catatan / Keterangan</label>
    <textarea id="catatan" rows="2" placeholder="Contoh: cuci kering, setrika, dll"></textarea>

    <label>Total Harga (Rp)</label>
    <input id="total" type="number" placeholder="0">

    <div class="row">
      <button id="saveBtn" class="primary">Simpan</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div id="saveMsg" class="muted"></div>

    <div id="previewArea" style="display:none;">
      <div class="thermal" id="previewBox"></div>
      <div class="row">
        <button id="waBtn" class="primary">Bagikan WA</button>
        <button id="copyBtn" class="secondary">Copy</button>
      </div>
    </div>

    <!-- SEARCH SECTION -->
    <div style="border-top:1px solid #eee; margin-top:16px; padding-top:12px;">
      <label>Cari Struk</label>
      <input id="searchInput" type="text" placeholder="Ketik No, Nama, Struk, atau No WA">
      <div class="row">
        <button id="searchBtn" class="primary">Cari</button>
        <button id="exportBtn" class="secondary">Ekspor CSV</button>
      </div>
      <div id="searchMsg" class="muted"></div>
      <div id="results"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const APPS_URL = "https://script.google.com/macros/s/AKfycbwd3F9qxpnhibR8qpbg4PTTrKe88EQcDWLvnm7vKbR2lpGDg07j9VqVyL1hxTeUPUmkNQ/exec";
  const el = id => document.getElementById(id);

  // Elemen
  const pinScreen = el('pinScreen'), mainScreen = el('mainScreen');
  const pinInput = el('pinInput'), pinBtn = el('pinBtn'), pinMsg = el('pinMsg');
  const noUrut = el('noUrut'), noKwitansi = el('noKwitansi');
  const nama = el('nama'), alamat = el('alamat'), nowa = el('nowa'), catatan = el('catatan');
  const total = el('total'), saveBtn = el('saveBtn'), resetBtn = el('resetBtn'), saveMsg = el('saveMsg');
  const previewArea = el('previewArea'), previewBox = el('previewBox');
  const waBtn = el('waBtn'), copyBtn = el('copyBtn');
  const searchInput = el('searchInput'), searchBtn = el('searchBtn'), exportBtn = el('exportBtn');
  const searchMsg = el('searchMsg'), results = el('results');

  const fmtCur = n => Number(n||0).toLocaleString('id-ID');
  const sanitizePhone = s => {
    let t = String(s||'').replace(/\D/g,'');
    if (t.startsWith('0')) t = '62' + t.slice(1);
    if (!t.startsWith('62')) t = '62' + t;
    return t;
  };
  const buildPreview = d => [
    '    RUMAH NENEK LAUNDRY',
    'Jl. Mashudi No 10 - Cariu',
    'WA/DANA 0895-6223-09251 a.n. Tita Juarsih',
    '----------------------------------',
    'No Struk   : ' + d.noKwitansi,
    'No Urut    : ' + d.noUrut,
    'Nama       : ' + d.nama,
    d.alamat ? 'Alamat     : ' + d.alamat : '',
    d.nowa ? 'WA          : ' + d.nowa : '',
    d.catatan ? 'Catatan    : ' + d.catatan : '',
    '----------------------------------',
    'Total      : Rp ' + fmtCur(d.total),
    '----------------------------------',
    new Date().toLocaleString('id-ID')
  ].filter(Boolean).join('\n');

  // PIN login
  pinBtn.onclick = async () => {
    pinMsg.textContent = 'Memeriksa PIN...';
    try {
      const res = await fetch(APPS_URL + '?action=checkPIN&pin=' + encodeURIComponent(pinInput.value));
      const txt = await res.text();
      if (txt.trim() === 'OK') {
        pinScreen.style.display = 'none';
        mainScreen.style.display = 'block';
        const d = await fetch(APPS_URL + '?action=getLast').then(r => r.json());
        noUrut.value = d.noUrut;
        noKwitansi.value = d.noKwitansi;
      } else pinMsg.textContent = 'PIN salah.';
    } catch { pinMsg.textContent = 'Gagal koneksi.'; }
  };

  // Simpan data
  saveBtn.onclick = async () => {
    const data = {
      noUrut: noUrut.value,
      noKwitansi: noKwitansi.value,
      nama: nama.value.trim(),
      alamat: alamat.value.trim(),
      nowa: nowa.value.trim(),
      catatan: catatan.value.trim(),
      total: total.value.trim()
    };
    if (!data.nama || !data.total) {
      saveMsg.textContent = 'Nama & total wajib diisi.';
      return;
    }
    saveMsg.textContent = 'Menyimpan...';
    try {
      const res = await fetch(APPS_URL + '?action=saveData&' + new URLSearchParams(data));
      const js = await res.json();
      saveMsg.textContent = js.message;
      if (js.status === 'success') {
        previewBox.textContent = buildPreview(data);
        previewArea.style.display = 'block';
        localStorage.removeItem('unsentData');
      }
    } catch {
      localStorage.setItem('unsentData', JSON.stringify(data));
      saveMsg.textContent = '⚠️ Koneksi gagal, data disimpan sementara. Akan dikirim ulang otomatis.';
    }
  };

  // Auto retry jika ada data tertunda
  window.addEventListener('load', async () => {
    const unsent = localStorage.getItem('unsentData');
    if (unsent) {
      const d = JSON.parse(unsent);
      try {
        await fetch(APPS_URL + '?action=saveData&' + new URLSearchParams(d));
        localStorage.removeItem('unsentData');
        alert('Data tertunda berhasil dikirim ulang ✅');
      } catch {}
    }
  });

  resetBtn.onclick = () => [nama, alamat, nowa, catatan, total].forEach(e => e.value = '');

  waBtn.onclick = () => {
    const t = encodeURIComponent(previewBox.textContent);
    const p = sanitizePhone(nowa.value);
    window.open('https://wa.me/' + p + '?text=' + t, '_blank');
  };

  copyBtn.onclick = () => {
    navigator.clipboard.writeText(previewBox.textContent);
    alert('Struk disalin ke clipboard ✅');
  };

  // Pencarian
  searchBtn.onclick = async () => {
    searchMsg.textContent = 'Mencari...';
    results.innerHTML = '';
    try {
      const q = searchInput.value.trim();
      const res = await fetch(APPS_URL + '?action=searchStruk&q=' + encodeURIComponent(q));
      const data = await res.json();
      searchMsg.textContent = data.length + ' hasil ditemukan';
      data.forEach(r => {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
          <b>${r.Nama}</b><br>
          No: ${r.No} | ${r.No_Struk}<br>
          Total: Rp ${fmtCur(r.Total)}<br>
          <div class="row">
            <button class="primary" onclick="window.open('https://wa.me/${sanitizePhone(r.No_WA)}?text='+encodeURIComponent('${r.Nama} | Total Rp ${fmtCur(r.Total)}'),'_blank')">Bagikan WA</button>
            <button onclick="if(confirm('Hapus struk ini?')) fetch('${APPS_URL}?action=deleteRow&no='+r.No)">Hapus</button>
            <button onclick="navigator.clipboard.writeText('${r.Nama} | Rp ${fmtCur(r.Total)}')">Copy</button>
          </div>
        `;
        results.appendChild(div);
      });
    } catch {
      searchMsg.textContent = 'Gagal memuat hasil.';
    }
  };

  exportBtn.onclick = () => window.open(APPS_URL + '?action=exportCSV&sheet=Struk', '_blank');
})();
</script>
</body>
</html>